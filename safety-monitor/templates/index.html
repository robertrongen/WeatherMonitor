<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/ico" href="{{ url_for('static', filename='favicon.ico') }}">
    <title>Sky Monitor - State Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            background-color: #000000; 
            color: #FFFFFF; 
            font-family: Arial, sans-serif; 
            padding: 20px;
            line-height: 1.6;
        }
        h1 { 
            font-size: 2em; 
            margin-bottom: 10px; 
            border-bottom: 3px solid #1E90FF;
            padding-bottom: 10px;
        }
        h2 { 
            font-size: 1.5em; 
            margin: 20px 0 15px 0;
            color: #1E90FF;
            border-left: 5px solid #1E90FF;
            padding-left: 10px;
        }
        h3 {
            font-size: 1.2em;
            margin: 15px 0 10px 0;
            color: #FFA500;
        }
        a, a:visited { color: #1E90FF; text-decoration: none; }
        a:hover { text-decoration: underline; }
        
        /* Alert styles */
        .alert { padding: 15px; margin: 10px 0; border-radius: 4px; font-weight: bold; }
        .alert-success { background-color: #388e3c; color: white; }
        .alert-error { background-color: #d32f2f; color: white; }
        
        /* Section containers */
        .section {
            background-color: #1a1a1a;
            border: 1px solid #333;
            border-radius: 6px;
            padding: 20px;
            margin: 20px 0;
        }
        
        /* Status indicators */
        .status-box {
            background-color: #0d0d0d;
            border-left: 4px solid;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .status-box.auto { border-left-color: #00FF00; }
        .status-box.manual { border-left-color: #FFA500; }
        .status-box.error { border-left-color: #FF0000; }
        .status-box.warning { border-left-color: #FFA500; }
        
        /* Actuator control grid */
        .actuator-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        .actuator-card {
            background-color: #0d0d0d;
            border: 1px solid #333;
            border-radius: 4px;
            padding: 15px;
        }
        .actuator-status {
            font-size: 1.1em;
            margin: 10px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .status-badge {
            padding: 5px 10px;
            border-radius: 3px;
            font-weight: bold;
            font-size: 0.9em;
        }
        .status-badge.on { background-color: #388e3c; color: white; }
        .status-badge.off { background-color: #666; color: white; }
        .status-badge.auto { background-color: #1976d2; color: white; }
        .status-badge.manual { background-color: #ff9800; color: white; }
        
        /* Buttons */
        button, .button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: opacity 0.2s;
        }
        button:hover { opacity: 0.8; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-on { background-color: #388e3c; color: white; }
        .btn-off { background-color: #d32f2f; color: white; }
        .btn-auto { background-color: #1976d2; color: white; }
        .btn-reset { background-color: #ff9800; color: white; }
        .btn-toggle { background-color: #1976d2; color: white; }
        
        /* Data display grid */
        .data-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }
        .data-item {
            background-color: #0d0d0d;
            padding: 12px;
            border-radius: 4px;
            border: 1px solid #333;
        }
        .data-label {
            font-size: 0.85em;
            color: #AAA;
            margin-bottom: 5px;
        }
        .data-value {
            font-size: 1.2em;
            font-weight: bold;
            color: #FFF;
        }
        .data-value.na {
            color: #888;
            font-style: italic;
        }
        
        /* Link list */
        ul {
            list-style: none;
            padding: 0;
        }
        li {
            padding: 8px 0;
            border-bottom: 1px solid #333;
        }
        li:last-child {
            border-bottom: none;
        }
        
        /* Warning text */
        .warning-text {
            font-size: 0.9em;
            color: #FFA500;
            margin-top: 15px;
            padding: 10px;
            background-color: #2a1a00;
            border-radius: 4px;
        }
        
        /* Snapshot metadata */
        .snapshot-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 12px;
            background-color: #0d0d0d;
            border-radius: 4px;
            border: 1px solid #333;
        }
        .meta-item {
            display: flex;
            flex-direction: column;
        }
        .meta-label {
            font-size: 0.85em;
            color: #AAA;
        }
        .meta-value {
            font-size: 1.1em;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}
        
        <h1>Sky Monitor - State Dashboard</h1>
        
        <!-- Alert Toggle -->
        <div class="section">
            <h2>Rain Alert System</h2>
            <div class="status-box {{ 'auto' if alert_active else 'manual' }}">
                <strong>Alert Status:</strong> {{ 'Enabled ✓' if alert_active else 'Disabled ✗' }}
            </div>
            <form method="POST" action="{{ '/disable-alert' if alert_active else '/enable-alert' }}" style="display: inline;">
                <button type="submit" class="btn-toggle">{{ 'Disable Alert' if alert_active else 'Enable Alert' }}</button>
            </form>
        </div>
        
        <!-- SECTION 1: Actuator Status & Manual Control -->
        <div class="section">
            <h2>1. Actuator Status &amp; Manual Control</h2>
            
            <div class="status-box {{ 'auto' if (data.fan_mode == 'AUTO' and data.heater_mode == 'AUTO') else 'manual' }}">
                <strong>Control Mode:</strong>
                {% if data.fan_mode == 'MANUAL' or data.heater_mode == 'MANUAL' %}
                    <span style="color: #FFA500;">⚠ Manual override active</span>
                {% else %}
                    <span style="color: #00FF00;">✓ Automatic control</span>
                {% endif %}
                {% if data.last_override_action %}
                    <br>
                    <span style="font-size: 0.9em; color: #AAA;">
                        Last action: {{ data.last_override_action }}
                        {% if data.last_override_time %}
                            ({{ data.last_override_time }})
                        {% endif %}
                    </span>
                {% endif %}
            </div>
            
            <div class="actuator-grid">
                <!-- Fan Control -->
                <div class="actuator-card">
                    <h3>Fan</h3>
                    <div class="actuator-status">
                        <span>State:</span>
                        <span class="status-badge {{ 'on' if data.fan_status == 'ON' else 'off' }}">
                            {{ data.fan_status }}
                        </span>
                    </div>
                    <div class="actuator-status">
                        <span>Mode:</span>
                        <span class="status-badge {{ 'auto' if data.fan_mode == 'AUTO' else 'manual' }}">
                            {{ data.fan_mode }}
                        </span>
                    </div>
                    <div style="margin-top: 15px;">
                        <form method="POST" action="/control/fan" style="display: inline;">
                            <input type="hidden" name="command" value="on">
                            <button type="submit" class="btn-on">ON</button>
                        </form>
                        <form method="POST" action="/control/fan" style="display: inline;">
                            <input type="hidden" name="command" value="off">
                            <button type="submit" class="btn-off">OFF</button>
                        </form>
                        <form method="POST" action="/control/fan" style="display: inline;">
                            <input type="hidden" name="command" value="auto">
                            <button type="submit" class="btn-auto">AUTO</button>
                        </form>
                    </div>
                </div>
                
                <!-- Heater Control -->
                <div class="actuator-card">
                    <h3>Heater</h3>
                    <div class="actuator-status">
                        <span>State:</span>
                        <span class="status-badge {{ 'on' if data.heater_status == 'ON' else 'off' }}">
                            {{ data.heater_status }}
                        </span>
                    </div>
                    <div class="actuator-status">
                        <span>Mode:</span>
                        <span class="status-badge {{ 'auto' if data.heater_mode == 'AUTO' else 'manual' }}">
                            {{ data.heater_mode }}
                        </span>
                    </div>
                    <div style="margin-top: 15px;">
                        <form method="POST" action="/control/heater" style="display: inline;">
                            <input type="hidden" name="command" value="on">
                            <button type="submit" class="btn-on">ON</button>
                        </form>
                        <form method="POST" action="/control/heater" style="display: inline;">
                            <input type="hidden" name="command" value="off">
                            <button type="submit" class="btn-off">OFF</button>
                        </form>
                        <form method="POST" action="/control/heater" style="display: inline;">
                            <input type="hidden" name="command" value="auto">
                            <button type="submit" class="btn-auto">AUTO</button>
                        </form>
                    </div>
                </div>
            </div>
            
            <div style="margin-top: 20px;">
                <form method="POST" action="/control/reset" style="display: inline;">
                    <button type="submit" class="btn-reset">RESET ALL TO AUTO</button>
                </form>
            </div>
            
            <p class="warning-text">
                ⚠️ Note: Manual commands are validated for safety. Critical conditions may override manual settings.
            </p>
        </div>
        
        <!-- SECTION 2: Latest Received Sensor Data -->
        <div class="section">
            <h2>2. Latest Received Sensor Data</h2>
            
            {% if data.timestamp and data.timestamp != 'N/A' %}
                <div class="snapshot-meta">
                    <div class="meta-item">
                        <span class="meta-label">Received Timestamp</span>
                        <span class="meta-value">{{ data.timestamp }}</span>
                    </div>
                    <div class="meta-item">
                        <span class="meta-label">Age</span>
                        <span class="meta-value" style="color: {{ '#FF0000' if data.age and 'h' in data.age else '#00FF00' if data.age and data.age != 'N/A' else '#888' }}">
                            {{ data.age }}
                        </span>
                    </div>
                    <div class="meta-item">
                        <span class="meta-label">System Mode</span>
                        <span class="meta-value" style="color: {{ '#00FF00' if data.mode == 'NORMAL' else '#FFA500' if data.mode == 'SAFE' else '#FF0000' }}">
                            {{ data.mode }}
                        </span>
                    </div>
                </div>
            {% else %}
                <div class="status-box warning">
                    <strong>⚠ No sensor data received yet</strong>
                    <p style="margin-top: 10px; font-size: 0.9em;">Waiting for first sensor transmission...</p>
                </div>
            {% endif %}
            
            <div class="data-grid">
                <div class="data-item">
                    <div class="data-label">Temperature</div>
                    <div class="data-value {{ 'na' if not data.temperature else '' }}">
                        {{ data.temperature if data.temperature else 'N/A' }}{{ ' °C' if data.temperature else '' }}
                    </div>
                </div>
                
                <div class="data-item">
                    <div class="data-label">Humidity</div>
                    <div class="data-value {{ 'na' if not data.humidity else '' }}">
                        {{ data.humidity if data.humidity else 'N/A' }}{{ ' %' if data.humidity else '' }}
                    </div>
                </div>
                
                <div class="data-item">
                    <div class="data-label">Raining</div>
                    <div class="data-value {{ 'na' if data.raining is none else '' }}" style="color: {{ '#FF0000' if data.raining else '#00FF00' if data.raining is not none else '#888' }}">
                        {{ 'YES' if data.raining else 'NO' if data.raining is not none else 'N/A' }}
                    </div>
                </div>
                
                <div class="data-item">
                    <div class="data-label">Wind</div>
                    <div class="data-value {{ 'na' if data.wind is none else '' }}" style="color: {{ '#FF0000' if data.wind else '#00FF00' if data.wind is not none else '#888' }}">
                        {{ 'YES' if data.wind else 'NO' if data.wind is not none else 'N/A' }}
                    </div>
                </div>
                
                <div class="data-item">
                    <div class="data-label">Sky Temperature</div>
                    <div class="data-value {{ 'na' if not data.sky_temperature else '' }}">
                        {{ data.sky_temperature if data.sky_temperature else 'N/A' }}{{ ' °C' if data.sky_temperature else '' }}
                    </div>
                </div>
                
                <div class="data-item">
                    <div class="data-label">Ambient Temperature</div>
                    <div class="data-value {{ 'na' if not data.ambient_temperature else '' }}">
                        {{ data.ambient_temperature if data.ambient_temperature else 'N/A' }}{{ ' °C' if data.ambient_temperature else '' }}
                    </div>
                </div>
                
                <div class="data-item">
                    <div class="data-label">SQM Lux</div>
                    <div class="data-value {{ 'na' if not data.sqm_lux else '' }}">
                        {{ data.sqm_lux if data.sqm_lux else 'N/A' }}
                    </div>
                </div>
                
                <div class="data-item">
                    <div class="data-label">Camera Temperature</div>
                    <div class="data-value {{ 'na' if not data.camera_temp else '' }}">
                        {{ data.camera_temp if data.camera_temp else 'N/A' }}{{ ' °C' if data.camera_temp else '' }}
                    </div>
                </div>
                
                <div class="data-item">
                    <div class="data-label">Star Count</div>
                    <div class="data-value {{ 'na' if not data.star_count else '' }}">
                        {{ data.star_count if data.star_count else 'N/A' }}
                    </div>
                </div>
                
                <div class="data-item">
                    <div class="data-label">Day / Night</div>
                    <div class="data-value {{ 'na' if not data.day_or_night else '' }}">
                        {{ data.day_or_night if data.day_or_night else 'N/A' }}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- SECTION 3: Calculated / Derived Values -->
        {% if data.dew_point or data.heat_index or data.cloud_coverage or data.brightness or data.bortle or data.cpu_temperature %}
        <div class="section">
            <h2>3. Calculated / Derived Values</h2>
            <p style="font-size: 0.9em; color: #AAA; margin-bottom: 15px;">
                Values computed from sensor data and system telemetry
            </p>
            
            <div class="data-grid">
                {% if data.dew_point %}
                <div class="data-item">
                    <div class="data-label">Dew Point</div>
                    <div class="data-value">{{ data.dew_point }} °C</div>
                </div>
                {% endif %}
                
                {% if data.heat_index %}
                <div class="data-item">
                    <div class="data-label">Heat Index</div>
                    <div class="data-value">{{ data.heat_index }} °C</div>
                </div>
                {% endif %}
                
                {% if data.cloud_coverage %}
                <div class="data-item">
                    <div class="data-label">Cloud Coverage</div>
                    <div class="data-value">{{ data.cloud_coverage }}%</div>
                </div>
                {% endif %}
                
                {% if data.brightness %}
                <div class="data-item">
                    <div class="data-label">Brightness</div>
                    <div class="data-value">{{ data.brightness }}</div>
                </div>
                {% endif %}
                
                {% if data.bortle %}
                <div class="data-item">
                    <div class="data-label">Bortle Scale</div>
                    <div class="data-value">{{ data.bortle }}</div>
                </div>
                {% endif %}
                
                {% if data.cpu_temperature %}
                <div class="data-item">
                    <div class="data-label">CPU Temperature</div>
                    <div class="data-value">{{ data.cpu_temperature }} °C</div>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}
        
        <!-- Links Section -->
        <div class="section">
            <h2>System Links</h2>
            <ul>
                <li><a href="http://allsky.local/allsky/index.php">Sky Monitor Camera</a></li>
                <li><a href="/settings">Settings</a></li>
                <li><a href="/dashboard">System Monitor Dashboard</a></li>
                <li><a href="https://meetjestad.net/data/sensors_recent.php?sensors=580">Meet je stad data</a></li>
            </ul>
        </div>
        
        {% if data.last_error %}
        <div class="status-box error">
            <strong>⚠ System Error:</strong><br>
            {{ data.last_error }}
        </div>
        {% endif %}
        
        {% if data.cycle_count %}
        <p style="text-align: center; color: #666; margin-top: 20px; font-size: 0.85em;">
            Control cycles: {{ data.cycle_count }}
            {% if data.uptime %} | Uptime: {{ data.uptime }}s{% endif %}
        </p>
        {% endif %}
    </div>
</body>
</html>
